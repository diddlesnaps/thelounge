name: thelounge
adopt-info: thelounge
summary:  Modern web IRC client designed for self-hosting.
description: |
 * **Modern features brought to IRC.** Push notifications, link previews, new message markers, and more bring IRC to the 21st century.
 * **Always connected.** Remains connected to IRC servers while you are offline.
 * **Cross platform.** It doesn't matter what OS you use, it just works wherever Node.js runs.
 * **Responsive interface.** The client works smoothly on every desktop, smartphone and tablet.
 * **Synchronized experience.** Always resume where you left off no matter what device.

base: core
grade: devel
confinement: strict

environment:
  LOUNGE_HOME: $SNAP_DATA/home

layout:
  $SNAP/.thelounge_home:
    bind-file: $SNAP/package/.thelounge_home

apps:
  lounged:
    command: bin/thelounge start
    daemon: simple
    plugs: [network-bind]
  thelounge:
    command: bin/thelounge
    plugs: [network-bind]

parts:
  thelounge:
    source: https://github.com/thelounge/thelounge
    source-type: git
    plugin: nodejs
    nodejs-package-manager: yarn
    override-pull: |
      snapcraftctl pull
      last_committed_tag="$(git describe --tags --abbrev=0)"
      last_released_tag="$(snap info $SNAPCRAFT_PROJECT_NAME | awk '$1 == "beta:" { print $2 }')"
      # If the latest tag from the upstream project has not been released to
      # beta, build that tag instead of master.
      if [ "${last_committed_tag}" != "${last_released_tag}" ]; then
        git fetch
        git checkout "${last_committed_tag}"
        snapcraftctl set-version "${last_committed_tag#v}"
      else
        snapcraftctl set-version "$(git rev-parse --short HEAD)"
      fi
  hack:
    plugin: nil
    source: .
    override-build: |
      snapcraftctl build
      echo /tmp > $SNAPCRAFT_STAGE/.thelounge_home

